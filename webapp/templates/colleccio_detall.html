<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ colleccio.nom }} - La trobada</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base_style.css') }}">
</head>
<body>
    <nav class="navbar" aria-label="Navegació principal">
        <div class="logo">La trobada</div>
        <div class="nav-links">
            <form action="/foro"><input type="submit" value="Foro" aria-label="Anar al fòrum"></form>
            <form action="/escaner"><input type="submit" value="Escaner" aria-label="Obrir escàner"></form>
            <form action="/colleccio"><input type="submit" value="Col·lecció" aria-label="Veure col·lecció"></form>
            <form action="/xat"><input type="submit" value="Xat" aria-label="Obrir xat"></form>
        </div>
        <div class="user-section">
            <div class="user-icon" aria-hidden="true">U</div>
            <form action="/usuari"><input type="submit" value="Usuari" aria-label="Configuració d'usuari"></form>
        </div>
    </nav>

    <main class="main-content">
        <div id="loading-indicator" aria-live="polite" aria-atomic="true">
            <p>Carregant cartes...</p>
        </div>

        <div class="carta-header">
            <div>
                <a href="/colleccio" class="back-link" aria-label="Tornar a col·leccions">
                    <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 5px;" aria-hidden="true">
                        <path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                    Tornar a col·leccions
                </a>
                <h1>{{ colleccio.nom }}</h1>
                <p class="collection-description">{{ colleccio.descripcio|default('Sense descripció') }}</p>
            </div>
            <div class="carta-actions">
                <span class="collection-stats" aria-label="Nombre de cartes">
                    {{ cartes|length }} {{ 'cartes' if cartes|length != 1 else 'carta' }}
                </span>
                <a href="/escaner?colleccio_id={{ colleccio.id }}" class="btn-add-card" aria-label="Afegir nova carta">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                        <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                    </svg>
                    Afegir carta
                </a>
            </div>
        </div>
        
        {% if error %}
            <div class="alert error" role="alert">{{ error }}</div>
        {% endif %}
        {% if success %}
            <div class="alert success" role="alert">{{ success }}</div>
        {% endif %}
        
        {% if cartes %}
        <div class="carta-grid">
            {% for carta in cartes %}
            <article class="carta-card">
                {% if carta.imatge_url %}
                <img src="{{ carta.imatge_url }}" alt="{{ carta.nom }}" class="carta-image" onerror="this.src='{{ url_for('static', filename='images/card-placeholder.png') }}'">
                {% else %}
                <img src="{{ url_for('static', filename='images/card-placeholder.png') }}" alt="Carta sense imatge" class="carta-image">
                {% endif %}
                <div class="carta-content">
                    <h3 class="carta-title">{{ carta.nom }}</h3>
                    <div class="carta-meta">
                        <span class="carta-rarity">{{ carta.raresa|default('Comú') }}</span>
                        <span class="carta-date">Afegida el {{ carta.data_afegit|default('data desconeguda') }}</span>
                    </div>
                    <p class="carta-description">{{ carta.descripcio|default('Sense descripció') }}</p>
                    <div class="card-actions">
                        <button class="btn-icon" onclick="mostrarDetallsCarta({{ carta.id }})" title="Veure detalls" aria-label="Veure detalls de la carta">
                            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                                <path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            </svg>
                        </button>
                        <button class="btn-icon delete-btn" onclick="eliminarCarta({{ colleccio.id }}, {{ carta.id }})" title="Eliminar carta" aria-label="Eliminar carta de la col·lecció">
                            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                                <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-cards">
            <img src="{{ url_for('static', filename='images/empty-cards.svg') }}" alt="Icona de col·lecció buida">
            <h2>Aquesta col·lecció està buida</h2>
            <p>No hi ha cap carta en aquesta col·lecció. Escaneja cartes per afegir-les.</p>
            <a href="/escaner?colleccio_id={{ colleccio.id }}" class="btn-add-card" style="margin-top: 15px;" aria-label="Afegir la primera carta">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                </svg>
                Afegir la primera carta
            </a>
        </div>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.search.includes('loading=true')) {
                document.getElementById('loading-indicator').style.display = 'block';
            }
        });

        function eliminarCarta(colleccioId, cartaId) {
            if (confirm("Estàs segur que vols eliminar aquesta carta de la col·lecció?")) {
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.style.display = 'block';
                
                fetch(`/eliminar_carta_colleccio/${colleccioId}/${cartaId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}' // Asegúrate de que tu backend soporte CSRF
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la red');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Recargar solo la sección de cartas en lugar de toda la página
                        location.reload();
                    } else {
                        alert(data.message || "Error desconegut");
                        loadingIndicator.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("S'ha produït un error en eliminar la carta");
                    loadingIndicator.style.display = 'none';
                });
            }
        }
        
        function mostrarDetallsCarta(cartaId) {
            // Implementación mejorada que muestra un modal con los detalles
            fetch(`/carta/${cartaId}/detalls`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Aquí deberías implementar un modal para mostrar los detalles
                        const modalContent = `
                            <h2>${data.carta.nom}</h2>
                            <img src="${data.carta.imatge_url || '/static/images/card-placeholder.png'}" alt="${data.carta.nom}">
                            <p>${data.carta.descripcio || 'Sense descripció'}</p>
                            <p>Raresa: ${data.carta.raresa || 'Comú'}</p>
                            <p>Afegida el: ${data.carta.data_afegit || 'Data desconeguda'}</p>
                        `;
                        // Implementa tu lógica para mostrar el modal aquí
                        alert(`Detalls de la carta:\nNom: ${data.carta.nom}\nDescripció: ${data.carta.descripcio || 'Sense descripció'}`);
                    } else {
                        alert("No s'han pogut carregar els detalls de la carta");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("S'ha produït un error en carregar els detalls");
                });
        }
    </script>
</body>
</html>